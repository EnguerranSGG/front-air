---
// Date de build comme fallback
const buildDate = new Date().toLocaleDateString('fr-FR');
---

<footer class="footer">
  <div class="footer-content">
    <div class="footer-section">
      <div class="siege-info" id="siege-info">
        <h4 class="siege-title">Siège social</h4>
        <p class="siege-loading">Chargement...</p>
      </div>
    </div>
    
    <div class="footer-section">
      <div class="legal-links">
        <a href="/mentions-legales" class="legal-link">Mentions légales</a>
        <a href="/politique-confidentialite" class="legal-link">Politique de confidentialité</a>
      </div>
    </div>
  </div>
  
  <div class="footer-bottom">
    <p class="last-update" id="last-update">
      Dernière mise à jour du site : {buildDate}
    </p>
  </div>
</footer>

<script>
  // Cache avec TTL (Time To Live) de 1 heure pour les données du footer
  const CACHE_TTL = 60 * 60 * 1000; // 1 heure en millisecondes
  const CACHE_KEYS = {
    SIEGE_SOCIAL: 'footer_siege_social',
    LAST_UPDATE: 'footer_last_update',
    CACHE_TIMESTAMP: 'footer_cache_timestamp'
  };

  // Fonction utilitaire pour vérifier si le cache est valide
  function isCacheValid() {
    const timestamp = localStorage.getItem(CACHE_KEYS.CACHE_TIMESTAMP);
    if (!timestamp) return false;
    const age = Date.now() - parseInt(timestamp, 10);
    return age < CACHE_TTL;
  }

  // Fonction pour charger les informations du siège social côté client (avec cache)
  async function loadSiegeSocial() {
    const siegeInfo = document.getElementById('siege-info');
    if (!siegeInfo) return;

    // Vérifier le cache d'abord
    if (isCacheValid()) {
      const cached = localStorage.getItem(CACHE_KEYS.SIEGE_SOCIAL);
      if (cached) {
        try {
          const siegeSocial = JSON.parse(cached);
          siegeInfo.innerHTML = `
            <h4 class="siege-title">Siège social</h4>
            ${siegeSocial.address ? `<p class="siege-address">${siegeSocial.address}</p>` : ''}
            ${siegeSocial.phone_number ? `<p class="siege-phone">${siegeSocial.phone_number}</p>` : ''}
          `;
          return; // Utiliser le cache, pas besoin de fetch
        } catch (e) {
          // Cache corrompu, continuer avec le fetch
        }
      }
    }

    // Cache invalide ou inexistant, faire le fetch
    try {
      const baseUrl = window.location.hostname === 'localhost' 
        ? 'http://localhost:3000/api' 
        : window.location.origin + '/api';
      const res = await fetch(`${baseUrl}/structures/all`);
      const data = await res.json();
      
      if (Array.isArray(data)) {
        const siegeSocial = data.find(structure => structure.structure_id === 1);
        
        if (siegeSocial) {
          // Mettre en cache
          localStorage.setItem(CACHE_KEYS.SIEGE_SOCIAL, JSON.stringify({
            address: siegeSocial.address,
            phone_number: siegeSocial.phone_number
          }));
          localStorage.setItem(CACHE_KEYS.CACHE_TIMESTAMP, Date.now().toString());
          
          siegeInfo.innerHTML = `
            <h4 class="siege-title">Siège social</h4>
            ${siegeSocial.address ? `<p class="siege-address">${siegeSocial.address}</p>` : ''}
            ${siegeSocial.phone_number ? `<p class="siege-phone">${siegeSocial.phone_number}</p>` : ''}
          `;
        } else {
          siegeInfo.innerHTML = `
            <h4 class="siege-title">Siège social</h4>
            <p class="no-data">Informations non disponibles</p>
          `;
        }
      } else {
        siegeInfo.innerHTML = `
          <h4 class="siege-title">Siège social</h4>
          <p class="no-data">Informations non disponibles</p>
        `;
      }
    } catch (err) {
      console.error('Erreur lors du fetch des structures pour footer :', err);
      siegeInfo.innerHTML = `
        <h4 class="siege-title">Siège social</h4>
        <p class="no-data">Informations non disponibles</p>
      `;
    }
  }

  // Fonction pour mettre à jour la date de dernière modification (avec cache)
  async function updateLastUpdateDate() {
    const lastUpdateElement = document.getElementById('last-update');
    if (!lastUpdateElement) return;

    // Vérifier le cache d'abord
    if (isCacheValid()) {
      const cached = localStorage.getItem(CACHE_KEYS.LAST_UPDATE);
      if (cached) {
        lastUpdateElement.textContent = `Dernière mise à jour du site : ${cached}`;
        return; // Utiliser le cache, pas besoin de fetch
      }
    }

    // Cache invalide ou inexistant, faire le fetch
    try {
      const baseUrl = window.location.hostname === 'localhost' 
        ? 'http://localhost:3000/api' 
        : window.location.origin + '/api';
      const apiUrl = baseUrl + '/last-update';
      
      const response = await fetch(apiUrl, {
        method: 'GET',
        headers: {
          'Accept': 'application/json',
        },
        mode: 'cors'
      });
      
      if (response.ok) {
        const data = await response.json();
        
        if (data.lastUpdate) {
          // Formater la date reçue de l'API
          const lastUpdateDate = new Date(data.lastUpdate).toLocaleDateString('fr-FR');
          
          // Mettre en cache
          localStorage.setItem(CACHE_KEYS.LAST_UPDATE, lastUpdateDate);
          localStorage.setItem(CACHE_KEYS.CACHE_TIMESTAMP, Date.now().toString());
          
          lastUpdateElement.textContent = `Dernière mise à jour du site : ${lastUpdateDate}`;
        }
      } else {
        console.warn('Erreur lors de la récupération de la date de dernière modification:', response.status);
        // Garder la date de build par défaut
      }
    } catch (error) {
      console.error('Erreur lors du fetch de la date de dernière modification:', error);
      // Garder la date de build par défaut en cas d'erreur
    }
  }

  // Appeler les fonctions au chargement de la page
  // Note: Ces fonctions utilisent maintenant le cache, donc elles sont rapides
  loadSiegeSocial();
  updateLastUpdateDate();
</script>

<style>
  .footer {
    background: #2c3e50;
    color: #ecf0f1;
    padding: 2rem 0;
    margin-top: auto;
  }

  .footer-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 2rem;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 2rem;
  }

  .footer-section {
    flex: 1;
  }

  .siege-info {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    align-items: flex-start;
  }

  .siege-title {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: #3498db;
    text-align: left;
  }

  .siege-loading {
    color: #95a5a6;
    font-style: italic;
    margin: 0;
  }

  .siege-address,
  .siege-phone {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
    color: #ecf0f1;
    font-size: 0.9rem;
  }

  .icon {
    width: 1rem;
    height: 1rem;
    flex-shrink: 0;
  }

  .no-data {
    color: #95a5a6;
    font-style: italic;
    margin: 0;
  }

  .legal-links {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .legal-link {
    color: #3498db;
    text-decoration: none;
    transition: color 0.3s ease;
    font-weight: 500;
  }

  .legal-link:hover {
    color: #5dade2;
  }

  .footer-bottom {
    border-top: 1px solid #34495e;
    margin-top: 2rem;
    padding-top: 1rem;
    text-align: center;
  }

  .last-update {
    color: #95a5a6;
    font-size: 0.85rem;
    margin: 0;
    font-style: italic;
  }

  /* Version mobile */
  @media (max-width: 768px) {
    .footer-content {
      flex-direction: column;
      gap: 1.5rem;
      text-align: center;
    }

    .footer-section {
      width: 100%;
    }

    .siege-address,
    .siege-phone {
      justify-content: center;
    }
  }
</style>
