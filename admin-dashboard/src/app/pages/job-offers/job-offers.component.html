<h2>💼 Gestion des offres d’emploi</h2>

<div class="filter-add-wrapper">
    <button (click)="showForm = !showForm">
        {{ showForm ? '❌ Annuler' : '➕ Ajouter une offre' }}
    </button>
</div>

<!-- Formulaire harmonisé -->
<form *ngIf="showForm" class="create-form" [formGroup]="form" (ngSubmit)="onSubmit()">
    <input formControlName="name" type="text" placeholder="Nom du poste" />
    <input formControlName="job_type" type="text" placeholder="Type de contrat" />
    <input formControlName="city" type="text" placeholder="Ville" />
    <input formControlName="link" type="text" placeholder="Lien de l’offre" />
    <textarea formControlName="description" placeholder="Description"></textarea>

    <div class="form-buttons">
        <!-- Bouton pour afficher/masquer les fichiers -->
        <button type="button" (click)="showFileSelector = !showFileSelector">
            {{ showFileSelector ? '❌ Fermer les images' : '📎 Lier une image' }}
        </button>

        <!-- Sélecteur de fichier conditionnel -->
        <div *ngIf="showFileSelector">
            <app-file-selector [files]="files" [selectedFileId]="form.value.file_id"
                (fileSelected)="form.patchValue({ file_id: $event })"></app-file-selector>
        </div>
        <button type="submit" [disabled]="form.invalid">
            {{ editingId ? 'Modifier' : 'Créer' }}
        </button>
        <button type="button" (click)="reset(); showForm = false" *ngIf="editingId">❌ Annuler</button>
    </div>
</form>

<div *ngFor="let offer of jobOffers" class="event-card">
    <!-- Si ce n’est pas l’offre en cours d’édition -->
    <ng-container *ngIf="editingId !== offer.job_offer_id; else editForm">
        <div class="event-content">
            <strong class="event-year">{{ offer.name }}</strong>
            <p class="event-description">{{ offer.job_type }} – {{ offer.city || 'Ville non renseignée' }}</p>
            <p class="event-description">{{ offer.description }}</p>

            <a *ngIf="offer.link" [href]="offer.link" target="_blank">🔗 Voir l’offre</a>

            <div *ngIf="offer.file_id">
                <img [src]="apiUrl + '/files/' + offer.file.file_id + '/download'" alt="Illustration" width="100" />
            </div>
        </div>

        <div class="event-buttons">
            <button (click)="edit(offer)">✏️ Modifier</button>
            <button (click)="delete(offer.job_offer_id)">🗑️ Supprimer</button>
        </div>
    </ng-container>

    <!-- Formulaire d'édition intégré à la carte -->
    <ng-template #editForm>
        <form class="create-form" [formGroup]="form" (ngSubmit)="onSubmit()">
            <input formControlName="name" type="text" placeholder="Nom du poste" />
            <input formControlName="job_type" type="text" placeholder="Type de contrat" />
            <input formControlName="city" type="text" placeholder="Ville" />
            <input formControlName="link" type="text" placeholder="Lien de l’offre" />
            <textarea formControlName="description" placeholder="Description"></textarea>

            <div class="form-buttons">
                <button type="button" (click)="showFileSelector = !showFileSelector">
                    {{ showFileSelector ? '❌ Fermer les images' : '📎 Lier une image' }}
                </button>

                <div *ngIf="showFileSelector">
                    <app-file-selector [files]="files" [selectedFileId]="form.value.file_id"
                        (fileSelected)="form.patchValue({ file_id: $event })">
                    </app-file-selector>
                </div>
                <button type="submit" [disabled]="form.invalid">💾 Sauvegarder</button>
                <button type="button" (click)="reset()">❌ Annuler</button>
            </div>
        </form>
    </ng-template>
</div>


<ng-template #noOffers>
    <p>Aucune offre disponible.</p>
</ng-template>