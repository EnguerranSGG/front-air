<h2>ğŸ’¼ Gestion des offres dâ€™emploi</h2>

<div class="filter-add-wrapper">
    <button (click)="showForm = !showForm">
        {{ showForm ? 'âŒ Annuler' : 'â• Ajouter une offre' }}
    </button>
</div>

<!-- Formulaire harmonisÃ© -->
<form *ngIf="showForm" class="create-form" [formGroup]="form" (ngSubmit)="onSubmit()">
    <!-- Nom du poste -->
    <input formControlName="name" type="text" placeholder="Nom du poste" />
    <div *ngIf="form.get('name')?.invalid && form.get('name')?.touched" class="error">
      <span *ngIf="form.get('name')?.errors?.['required']">Le nom est obligatoire.</span>
      <span *ngIf="form.get('name')?.errors?.['maxlength']">Le nom ne doit pas dÃ©passer 60 caractÃ¨res.</span>
    </div>
  
    <!-- Type de contrat -->
    <input formControlName="job_type" type="text" placeholder="Type de contrat" />
    <div *ngIf="form.get('job_type')?.invalid && form.get('job_type')?.touched" class="error">
      <span *ngIf="form.get('job_type')?.errors?.['required']">Le type de contrat est obligatoire.</span>
      <span *ngIf="form.get('job_type')?.errors?.['maxlength']">Le type ne doit pas dÃ©passer 60 caractÃ¨res.</span>
    </div>
  
    <!-- Ville -->
    <input formControlName="city" type="text" placeholder="Ville" />
    <div *ngIf="form.get('city')?.invalid && form.get('city')?.touched" class="error">
      <span *ngIf="form.get('city')?.errors?.['maxlength']">La ville ne doit pas dÃ©passer 50 caractÃ¨res.</span>
    </div>
  
    <!-- Lien -->
    <input formControlName="link" type="text" placeholder="Lien de lâ€™offre" />
    <div *ngIf="form.get('link')?.invalid && form.get('link')?.touched" class="error">
      <span *ngIf="form.get('link')?.errors?.['maxlength']">Le lien ne doit pas dÃ©passer 255 caractÃ¨res.</span>
      <span *ngIf="form.get('link')?.errors?.['pattern']">Le lien doit commencer par http(s).</span>
    </div>
  
    <!-- Description -->
    <textarea formControlName="description" placeholder="Description"></textarea>
    <div *ngIf="form.get('description')?.invalid && form.get('description')?.touched" class="error">
      <span *ngIf="form.get('description')?.errors?.['required']">La description est obligatoire.</span>
      <span *ngIf="form.get('description')?.errors?.['maxlength']">La description ne doit pas dÃ©passer 350 caractÃ¨res.</span>
    </div>
  
    <!-- Fichier -->
    <div class="form-buttons">
      <button type="button" (click)="showFileSelector = !showFileSelector">
        {{ showFileSelector ? 'âŒ Fermer les images' : 'ğŸ“ Lier une image' }}
      </button>
  
      <div *ngIf="showFileSelector">
        <app-file-selector [files]="files" [selectedFileId]="form.value.file_id"
          (fileSelected)="form.patchValue({ file_id: $event })">
        </app-file-selector>
      </div>
  
      <button type="submit" [disabled]="form.invalid">
        {{ editingId ? 'Modifier' : 'CrÃ©er' }}
      </button>
      <button type="button" (click)="reset(); showForm = false" *ngIf="editingId">âŒ Annuler</button>
    </div>
  </form>
  
<div *ngFor="let offer of jobOffers" class="event-card">
    <!-- Si ce nâ€™est pas lâ€™offre en cours dâ€™Ã©dition -->
    <ng-container *ngIf="editingId !== offer.job_offer_id; else editForm">
        <div class="event-content">
            <strong class="event-year">{{ offer.name }}</strong>
            <p class="event-description">{{ offer.job_type }} â€“ {{ offer.city || 'Ville non renseignÃ©e' }}</p>
            <p class="event-description">{{ offer.description }}</p>

            <a *ngIf="offer.link" [href]="offer.link" target="_blank">ğŸ”— Voir lâ€™offre</a>

            <div *ngIf="offer.file_id">
                <img [src]="apiUrl + '/files/' + offer.file.file_id + '/download'" alt="Illustration" width="100" />
            </div>
        </div>

        <div class="event-buttons">
            <button (click)="edit(offer)">âœï¸ Modifier</button>
            <button (click)="delete(offer.job_offer_id)">ğŸ—‘ï¸ Supprimer</button>
        </div>
    </ng-container>

    <!-- Formulaire d'Ã©dition intÃ©grÃ© Ã  la carte -->
    <ng-template #editForm>
        <form class="create-form" [formGroup]="form" (ngSubmit)="onSubmit()">
            <input formControlName="name" type="text" placeholder="Nom du poste" />
            <input formControlName="job_type" type="text" placeholder="Type de contrat" />
            <input formControlName="city" type="text" placeholder="Ville" />
            <input formControlName="link" type="text" placeholder="Lien de lâ€™offre" />
            <textarea formControlName="description" placeholder="Description"></textarea>

            <div class="form-buttons">
                <button type="button" (click)="showFileSelector = !showFileSelector">
                    {{ showFileSelector ? 'âŒ Fermer les images' : 'ğŸ“ Lier une image' }}
                </button>

                <div *ngIf="showFileSelector">
                    <app-file-selector [files]="files" [selectedFileId]="form.value.file_id"
                        (fileSelected)="form.patchValue({ file_id: $event })">
                    </app-file-selector>
                </div>
                <button type="submit" [disabled]="form.invalid">ğŸ’¾ Sauvegarder</button>
                <button type="button" (click)="reset()">âŒ Annuler</button>
            </div>
        </form>
    </ng-template>
</div>


<ng-template #noOffers>
    <p>Aucune offre disponible.</p>
</ng-template>