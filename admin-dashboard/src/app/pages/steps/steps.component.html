<h2>ğŸš¶â€â™‚ï¸ Gestion des Ã©tapes</h2>

<!-- Filtres et bouton dâ€™ajout -->
<div class="filter-add-wrapper">
  <select (change)="onPathFilterChange($event)">
    <option value="">Toutes les Ã©tapes</option>
    <option *ngFor="let path of paths" [value]="path.path_id">
      {{ path.name | sanitize }}
    </option>
  </select>

  <button (click)="showCreate = !showCreate">
    {{ showCreate ? 'âŒ Annuler' : 'â• Ajouter une Ã©tape' }}
  </button>
</div>

<!-- Formulaire d'ajout -->
<form *ngIf="showCreate" class="create-form" [formGroup]="createForm" (ngSubmit)="addStep()">
  <!-- Nom de lâ€™Ã©tape -->
  <input formControlName="name" placeholder="Nom de lâ€™Ã©tape" />
  <div *ngIf="createForm.get('name')?.invalid && createForm.get('name')?.touched" class="error">
    <span *ngIf="createForm.get('name')?.errors?.['required']">Le nom est obligatoire.</span>
    <span *ngIf="createForm.get('name')?.errors?.['maxlength']">Le nom ne doit pas dÃ©passer 100 caractÃ¨res.</span>
  </div>

  <!-- Description -->
  <textarea formControlName="description" placeholder="Description"></textarea>
  <div *ngIf="createForm.get('description')?.invalid && createForm.get('description')?.touched" class="error">
    <span *ngIf="createForm.get('description')?.errors?.['required']">La description est obligatoire.</span>
    <span *ngIf="createForm.get('description')?.errors?.['maxlength']">La description ne doit pas dÃ©passer 390
      caractÃ¨res.</span>
  </div>

  <!-- Parcours -->
  <select formControlName="path_id" required>
    <option [ngValue]="null" disabled>Choisir un parcours</option>
    <option *ngFor="let path of paths" [ngValue]="path.path_id">
      {{ path.name }}
    </option>
  </select>
  <div *ngIf="createForm.get('path_id')?.invalid && createForm.get('path_id')?.touched" class="error">
    <span *ngIf="createForm.get('path_id')?.errors?.['required']">Le parcours est obligatoire.</span>
    <span *ngIf="createForm.get('path_id')?.errors?.['min']">Veuillez sÃ©lectionner un parcours valide.</span>
  </div>

  <!-- Fichier -->
  <button type="button" (click)="showCreateFileSelector = !showCreateFileSelector">
    {{ showCreateFileSelector ? 'âŒ Fermer les images' : 'ğŸ“ Lier une image' }}
  </button>

  <div *ngIf="showCreateFileSelector">
    <app-file-selector [files]="files" [selectedFileId]="createForm.value.file_id"
      (fileSelected)="onFileSelect($event)">
    </app-file-selector>
  </div>

  <div class="form-buttons">
    <button type="submit" [disabled]="createForm.invalid">â• Ajouter</button>
  </div>
</form>


<!-- Liste des Ã©tapes -->
<div *ngFor="let step of steps" class="event-card">
  <div *ngIf="editingId !== step.step_id">
    <div class="event-content">
      <strong class="event-year">{{ step.name | sanitize }}</strong>
      <p class="event-description">{{ step.description | sanitize }}</p>
      <p class="event-description"><em>Parcours :</em> {{ getPathName(step.path_id) }}</p>
      <div *ngIf="step.file?.file_id">
        <img [src]="apiUrl + '/files/' + step.file?.file_id + '/download'" alt="{{ step.name | sanitize }}" width="100" />
      </div>
    </div>
    <div class="event-buttons">
      <button (click)="startEdit(step)">âœï¸ Modifier</button>
      <button (click)="deleteStep(step.step_id)">ğŸ—‘ï¸ Supprimer</button>
    </div>
  </div>

  <!-- Formulaire de modification -->
  <form *ngIf="editingId === step.step_id" class="create-form" [formGroup]="editForm" (ngSubmit)="saveEdit(step)">
    <input formControlName="name" placeholder="Nom de lâ€™Ã©tape" />
    <div *ngIf="editForm.get('name')?.invalid && editForm.get('name')?.touched" class="error">
      <span *ngIf="editForm.get('name')?.errors?.['required']">Le nom est obligatoire.</span>
      <span *ngIf="editForm.get('name')?.errors?.['maxlength']">Le nom ne doit pas dÃ©passer 100 caractÃ¨res.</span>
    </div>

    <textarea formControlName="description" placeholder="Description"></textarea>
    <div *ngIf="editForm.get('description')?.invalid && editForm.get('description')?.touched" class="error">
      <span *ngIf="editForm.get('description')?.errors?.['required']">La description est obligatoire.</span>
      <span *ngIf="editForm.get('description')?.errors?.['maxlength']">La description ne doit pas dÃ©passer 390
        caractÃ¨res.</span>
    </div>

    <select formControlName="path_id" required>
      <option [ngValue]="null" disabled>Choisir un parcours</option>
      <option *ngFor="let path of paths" [ngValue]="path.path_id">
        {{ path.name }}
      </option>
    </select>
    <div *ngIf="editForm.get('path_id')?.invalid && editForm.get('path_id')?.touched" class="error">
      <span *ngIf="editForm.get('path_id')?.errors?.['required']">Le parcours est obligatoire.</span>
      <span *ngIf="editForm.get('path_id')?.errors?.['min']">Veuillez sÃ©lectionner un parcours valide.</span>
    </div>

    <button type="button" (click)="showEditFileSelector = !showEditFileSelector">
      {{ showEditFileSelector ? 'âŒ Fermer les images' : 'ğŸ“ Lier une image' }}
    </button>

    <div *ngIf="showEditFileSelector">
      <app-file-selector [files]="files" [selectedFileId]="editForm.value.file_id"
        (fileSelected)="onFileSelect($event)">
      </app-file-selector>
    </div>

    <div class="form-buttons">
      <button type="submit" [disabled]="editForm.invalid">ğŸ’¾ Sauvegarder</button>
      <button type="button" (click)="cancelEdit()">âŒ Annuler</button>
    </div>
  </form>

</div>