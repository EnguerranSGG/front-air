<h2>ğŸ¢ Gestion des structures</h2>

<!-- Bouton dâ€™ajout -->
<div class="filter-add-wrapper">
  <button (click)="showForm = !showForm">
    {{ showForm ? 'âŒ Annuler' : 'â• Ajouter une structure' }}
  </button>
</div>

<!-- Formulaire de crÃ©ation -->
<form *ngIf="showForm" class="create-form" [formGroup]="createForm" (ngSubmit)="addStructure()">
  <!-- Nom -->
  <input type="text" formControlName="name" placeholder="Nom" />
  <div *ngIf="createForm.get('name')?.invalid && createForm.get('name')?.touched" class="error">
    <span *ngIf="createForm.get('name')?.errors?.['required']">Le nom est obligatoire.</span>
    <span *ngIf="createForm.get('name')?.errors?.['maxlength']">Le nom ne doit pas dÃ©passer 60 caractÃ¨res.</span>
  </div>

  <!-- Fichier -->
  <button type="button" (click)="showCreateFileSelector = !showCreateFileSelector">
    {{ showCreateFileSelector ? 'âŒ Fermer les images' : 'ğŸ“ Lier un fichier' }}
  </button>
  <div *ngIf="showCreateFileSelector">
    <app-file-selector [files]="files" [selectedFileId]="createForm.value.file_id" (fileSelected)="onFileSelect($event)">
    </app-file-selector>
  </div>

  <!-- Description -->
  <textarea formControlName="description" placeholder="Description"></textarea>
  <div *ngIf="createForm.get('description')?.invalid && createForm.get('description')?.touched" class="error">
    <span *ngIf="createForm.get('description')?.errors?.['required']">La description est obligatoire.</span>
    <span *ngIf="createForm.get('description')?.errors?.['maxlength']">La description ne doit pas dÃ©passer 330 caractÃ¨res.</span>
  </div>

  <!-- Adresse -->
  <input type="text" formControlName="address" placeholder="Adresse" />
  <div *ngIf="createForm.get('address')?.invalid && createForm.get('address')?.touched" class="error">
    <span *ngIf="createForm.get('address')?.errors?.['maxlength']">L'adresse ne doit pas dÃ©passer 255 caractÃ¨res.</span>
  </div>

  <!-- TÃ©lÃ©phone -->
  <input type="text" formControlName="phone_number" placeholder="TÃ©lÃ©phone" />
  <div *ngIf="createForm.get('phone_number')?.invalid && createForm.get('phone_number')?.touched" class="error">
    <span *ngIf="createForm.get('phone_number')?.errors?.['maxlength']">Le numÃ©ro ne doit pas dÃ©passer 25 caractÃ¨res.</span>
  </div>

  <!-- Lien -->
  <input type="text" formControlName="link" placeholder="Lien" />
  <div *ngIf="createForm.get('link')?.invalid && createForm.get('link')?.touched" class="error">
    <span *ngIf="createForm.get('link')?.errors?.['maxlength']">Le lien ne doit pas dÃ©passer 255 caractÃ¨res.</span>
    <span *ngIf="createForm.get('link')?.errors?.['pattern']">Le lien doit commencer par http(s).</span>
  </div>

  <!-- Missions -->
  <div formArrayName="missions">
    <div *ngFor="let mission of createMissions.controls; let i = index" class="mission-line">
      <input [formControlName]="i" placeholder="Mission" />
      <div *ngIf="mission.invalid && mission.touched" class="error">
        <span *ngIf="mission.errors?.['maxlength']">La mission ne doit pas dÃ©passer 250 caractÃ¨res.</span>
      </div>
      <button type="button" (click)="removeMission(createForm, i)">âŒ</button>
    </div>
    <button type="button" (click)="addMission(createForm)">â• Ajouter une mission</button>
  </div>

  <div class="form-buttons">
    <button type="submit" [disabled]="createForm.invalid">CrÃ©er</button>
  </div>
</form>

<!-- Liste des structures -->
<div *ngFor="let structure of structures" class="event-card">
  <ng-container *ngIf="editingStructureId !== structure.structure_id; else editTemplate">
    <div class="event-content">
      <strong class="event-year">{{ structure.name | sanitize }}</strong>
      <div *ngIf="structure.file?.file_id">
        <img [src]="apiUrl + '/files/' + structure.file?.file_id + '/download'" [alt]="structure.name" width="100" />
      </div>
      <p class="event-description">{{ structure.description | sanitize }}</p>
      <p *ngIf="structure.address"><strong>Adresse :</strong> {{ structure.address | sanitize }}</p>
      <p *ngIf="structure.phone_number"><strong>TÃ©lÃ©phone :</strong> {{ structure.phone_number | sanitize }}</p>
      <p *ngIf="structure.link">
        <strong>Lien :</strong> <a [href]="structure.link" target="_blank">{{ structure.link | sanitize }}</a>
      </p>
      <ul *ngIf="structure.missions?.length">
        <li *ngFor="let mission of structure.missions">{{ mission.content | sanitize }}</li>
      </ul>
    </div>
    <div class="event-buttons">
      <button (click)="startEdit(structure)">âœï¸ Modifier</button>
      <button (click)="deleteStructure(structure.structure_id)">ğŸ—‘ï¸ Supprimer</button>
    </div>
  </ng-container>

  <!-- Formulaire de modification -->
  <ng-template #editTemplate>
    <form class="create-form" [formGroup]="editForm" (ngSubmit)="saveEdit(structure)">
      <input type="text" formControlName="name" placeholder="Nom" />
      <div *ngIf="editForm.get('name')?.invalid && editForm.get('name')?.touched" class="error">
        <span *ngIf="editForm.get('name')?.errors?.['required']">Le nom est obligatoire.</span>
        <span *ngIf="editForm.get('name')?.errors?.['maxlength']">Le nom ne doit pas dÃ©passer 60 caractÃ¨res.</span>
      </div>

      <button type="button" (click)="showEditFileSelector = !showEditFileSelector">
        {{ showEditFileSelector ? 'âŒ Fermer les images' : 'ğŸ“ Lier un fichier' }}
      </button>
      <div *ngIf="showEditFileSelector">
        <app-file-selector [files]="files" [selectedFileId]="editForm.value.file_id" (fileSelected)="onFileSelect($event)">
        </app-file-selector>
      </div>

      <textarea formControlName="description" placeholder="Description"></textarea>
      <div *ngIf="editForm.get('description')?.invalid && editForm.get('description')?.touched" class="error">
        <span *ngIf="editForm.get('description')?.errors?.['required']">La description est obligatoire.</span>
        <span *ngIf="editForm.get('description')?.errors?.['maxlength']">La description ne doit pas dÃ©passer 330 caractÃ¨res.</span>
      </div>

      <input type="text" formControlName="address" placeholder="Adresse" />
      <div *ngIf="editForm.get('address')?.invalid && editForm.get('address')?.touched" class="error">
        <span *ngIf="editForm.get('address')?.errors?.['maxlength']">L'adresse ne doit pas dÃ©passer 255 caractÃ¨res.</span>
      </div>

      <input type="text" formControlName="phone_number" placeholder="TÃ©lÃ©phone" />
      <div *ngIf="editForm.get('phone_number')?.invalid && editForm.get('phone_number')?.touched" class="error">
        <span *ngIf="editForm.get('phone_number')?.errors?.['maxlength']">Le numÃ©ro ne doit pas dÃ©passer 25 caractÃ¨res.</span>
      </div>

      <input type="text" formControlName="link" placeholder="Lien" />
      <div *ngIf="editForm.get('link')?.invalid && editForm.get('link')?.touched" class="error">
        <span *ngIf="editForm.get('link')?.errors?.['maxlength']">Le lien ne doit pas dÃ©passer 255 caractÃ¨res.</span>
        <span *ngIf="editForm.get('link')?.errors?.['pattern']">Le lien doit commencer par http(s).</span>
      </div>

      <div formArrayName="missions">
        <div *ngFor="let mission of editMissions.controls; let i = index" class="mission-line">
          <input [formControlName]="i" placeholder="Mission" />
          <div *ngIf="mission.invalid && mission.touched" class="error">
            <span *ngIf="mission.errors?.['maxlength']">La mission ne doit pas dÃ©passer 250 caractÃ¨res.</span>
          </div>
          <button type="button" (click)="removeMission(editForm, i)">âŒ</button>
        </div>
        <button type="button" (click)="addMission(editForm)">â• Ajouter une mission</button>
      </div>

      <div class="form-buttons">
        <button type="submit" [disabled]="editForm.invalid">ğŸ’¾ Sauvegarder</button>
        <button type="button" (click)="cancelEdit()">âŒ Annuler</button>
      </div>
    </form>
  </ng-template>
</div>
